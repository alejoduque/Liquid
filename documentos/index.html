<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>M A N A K A I - R E S E R V A - C O L O M B I A</title>
    <script type="text/javascript" src="../jquery.js"></script>
    <script type="text/javascript" src="../script.js"></script>
    <link rel="stylesheet" href="../css/style.css" media="all">
</head>
<body>
    <div id="info"></div>
    <ul id="content"></ul>

    <script>
        function convertUrlsToLinks(text) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return text.replace(urlRegex, (url) => {
                return `<a href="${url}">${url}</a>`; // Removed target="_blank"
            });
        }

        function formatDate(timestamp) {
            const date = new Date(timestamp * 1000);
            return date.toLocaleString();
        }

        async function loadMessages() {
            try {
                // Fetch the JSON data
                const response = await fetch('/datos.json');
                const data = await response.json();
                const content = document.getElementById('content');
                const info = document.getElementById('info');

                // Determine current folder type from URL
                const currentFolder = window.location.pathname.split('/').filter(Boolean).pop();

                // Filter messages for current folder type
                const filteredData = data.filter(msg => msg.type.toLowerCase() === currentFolder.toLowerCase());

                // Sort messages by date in descending order
                filteredData.sort((a, b) => b.date - a.date);

                // Update info with total number of messages
                // info.textContent = `Total de archivos en ${currentFolder}: ${filteredData.length}`;

                // Clear previous content
                content.innerHTML = '';

                // Render messages
                filteredData.forEach(msg => {
                    const li = document.createElement('li');
                    // Construct full file URL based on the public URL generated by the bot
                    const fileUrl = msg.file; // Use the public URL directly from datos.json

                    // Determine message content based on type
                    let messageContent = '';
                    switch(msg.type.toLowerCase()) {
                        case 'texto':
                            messageContent = convertUrlsToLinks(msg.file);
                            break;
                        case 'foto':
                            messageContent = `Foto enviada: <a href="${fileUrl}">Ver imagen</a>`;
                            break;
                        case 'video':
                            messageContent = `Video enviado: <a href="${fileUrl}">Ver video</a>`;
                            break;
                        case 'audio':
                            messageContent = `Audio enviado: <a href="${fileUrl}">Escuchar audio</a>`;
                            break;
                        case 'documentos':
                            messageContent = `Documento enviado: <a href="${fileUrl}">Abrir documento</a>`;
                            break;
                        default:
                            messageContent = `Archivo: <a href="${fileUrl}">${msg.file}</a>`;
                    }

                    li.innerHTML = `<strong>${msg.from_name}</strong> (${formatDate(msg.date)}): <br>${messageContent}`;
                    content.appendChild(li);
                });
            } catch (error) {
                console.error('Error loading messages:', error);
                document.getElementById('info').textContent = `Error: ${error.message}`;
            }
        }

        // Load messages when the page loads
        document.addEventListener('DOMContentLoaded', loadMessages);
    </script>

    <div class="container">
        <ul id="fileList" class="file-list">... <!-- Files will be dynamically populated here --> </ul>
        <div id="debugInfo"></div>
    </div>

    <div id="tipo_carpeta">
        <a href="../foto/" class="item">Fotos</a>
        <a href="../documentos/" class="item">Documentos</a>
        <a href="../video/" class="item">Videos</a>
        <a href="../audio/" class="item">Audios</a>
        <a href="../texto/" class="item">Textos</a>
    </div>

    <header class="header">
      <a href="../" id="back-link">← Volver al índice</a>
      <pre class="ascii-logo">
        .  .   .-.   . .   .-.   . .   .-.   .-.
        |\/|   |-|   |\|   |-|   |<    |-|    |
        '  `   ` '   ' `   ` '   ' `   ` '   `-'
        <a href="https://github.com/alejoduque/LiquidIce">software > alejoduque/LiquidIce</a>
      </pre>
    </header>
</body>
</html>
